## 参考
- [pBFT算法的关键设计，你可能忽视了](https://learnblockchain.cn/article/2384)
- [详解实用拜占庭协议PBFT](https://learnblockchain.cn/2019/08/29/pbft/)

## 基本概念



* View视图

>这个机制下有一个叫视图view的概念，在一个视图里，一个是主节点，其余的都叫备份节点。主节点负责将来自客户端的请求给排好序，然后按序发送给备份节点们。但是主节点可能会是拜占庭的：它可能会给不同的请求编上相同的序号，或者不去分配序号，或者让相邻的序号不连续。备份节点应当有职责来主动检查这些序号的合法性，并能通过timeout机制检测到主节点是否已经宕掉。当出现这些异常情况时，这些备份节点就会触发视图更换view change协议来选举出新的主节点。

$$p=v \mod ｜R｜$$

R是节点数目，V是View编号，p就是选择出来的主节点

## 设计原理

* 为何支持3f+1的容错能力

PBFT有一个最基本最重要的大前提，只要非拜占庭节点（诚实节点）占据大多数，那么提议就是可靠可信的

> 为何至少3f+1？
拜占庭容错算法的目的是使得所有诚实的节点最终状态一致并且是正确的。要达到这样的目的，必须满足诚实的节点数量多于恶意的节点（少数服从多数）。
在实际的开放网络环境中，不仅有恶意节点，还有由于网络拥堵或机器故障等原因，存在部分短暂失联的节点，也需要作为考虑的因素。
因此，假设恶意节点和失联节点的数量均为f，全网节点总数量为N，那么按照少数服从多数原则，剩余的诚实节点必须满足N-f-f>f，由此可得，N>3f，即N不少于3f+1。


在同一个view中会出现多个消息需要共识，每个序列号n对应一个m

不同的view的消息是独立的，需要区分

其中pre-prepare和prepare阶段最重要的任务是保证，同一个主节点发出的请求在同一个视图（view）中的顺序是一致的，prepare和commit阶段最重要的任务是保证请求在不同视图之间的顺序是一致的。

## 为什么要经过Pre-Prepare、Prepare、Commit三个步骤？
### Pre-Prepare 和Prepare的作用
确保所有请求在同一个View的顺序

每个副本收到2f+1个（包括自己）Pre-Prepare的请求的时候，就可以进入到Prepare的状态

总量为3f+1，如果收到2f的时候剩下的f个副本超时发送，可能是故障了，就可忽略不用再等待（先将故障的副本给排除掉），
收到2f个消息并且验证通过的时候，说明至少有f+1个非拜占庭节点认真了这个消息

### Prepare 与Commit的作用
确保夸View的请求的顺序


